/**
 * @fileoverview Firestore Security Rules for a luxury job and course platform.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles and their related data (applications, purchased courses).
 * Job postings, internships, and courses are publicly readable, but only admins can modify them.
 * Contact form submissions are publicly writable, but only admins can read them.
 *
 * Data Structure:
 * - /jobPostings/{jobPostingId}: Publicly readable job postings.
 * - /internships/{internshipId}: Publicly readable internships.
 * - /courses/{courseId}: Publicly readable courses.
 * - /users/{userId}: User profiles, only accessible by the owning user.
 * - /users/{userId}/applications/{applicationId}: Applications submitted by a user, only accessible by the owning user.
 * - /users/{userId}/purchasedCourses/{courseId}: Courses purchased by a user, only accessible by the owning user.
 * - /employees/{employeeId}: Employee data, only accessible by admins.
 * - /roles_admin/{userId}: Documents indicating admin privileges.
 * - /contactMessages/{contactMessageId}: Publicly writable contact submissions.
 *
 * Key Security Decisions:
 * - Public listing of job postings, internships, and courses.
 * - Strict user ownership for user profiles and associated data.
 * - Admin-only access for employee data and modification of job postings, internships, and courses.
 * - No user listing is allowed.
 * - Public write access for contact messages, admin-only read.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants public read access to job postings, but restricts create, update, and delete operations to admins.
     * @path /jobPostings/{jobPostingId}
     * @allow (get, list) Public read access.
     * @allow (create, update, delete) Admin user with matching role.
     * @deny (create, update, delete) Non-admin user.
     * @principle Public read, admin-only write for job postings.
     */
    match /jobPostings/{jobPostingId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Grants public read access to internships, but restricts create, update, and delete operations to admins.
     * @path /internships/{internshipId}
     * @allow (get, list) Public read access.
     * @allow (create, update, delete) Admin user with matching role.
     * @deny (create, update, delete) Non-admin user.
     * @principle Public read, admin-only write for internships.
     */
    match /internships/{internshipId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Grants public read access to courses, but restricts create, update, and delete operations to admins.
     * @path /courses/{courseId}
     * @allow (get, list) Public read access.
     * @allow (create, update, delete) Admin user with matching role.
     * @deny (create, update, delete) Non-admin user.
     * @principle Public read, admin-only write for courses.
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Grants read and write access to a user's own profile, based on matching the requested user ID with the authenticated user ID.
     * @path /users/{userId}
     * @allow (get, create, update, delete, list) Authenticated user accessing their own profile.
     * @deny (get, create, update, delete, list) Any user attempting to access another user's profile.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get, update, delete: if isOwner(userId) && resource != null;
      allow create: if isOwner(userId);
      allow list: if false;
    }

    /**
     * @description Grants read and write access to a user's own applications, based on matching the requested user ID with the authenticated user ID.
     * @path /users/{userId}/applications/{applicationId}
     * @allow (get, create, update, delete, list) Authenticated user accessing their own applications.
     * @deny (get, create, update, delete, list) Any user attempting to access another user's applications.
     * @principle Enforces document ownership for applications.
     */
    match /users/{userId}/applications/{applicationId} {
      allow get, list, update, delete: if isOwner(userId) && resource != null;
      allow create: if isOwner(userId) && request.resource.data.userProfileId == userId;
    }

      /**
       * @description Grants read and write access to a user's purchased courses, based on matching the requested user ID with the authenticated user ID.
       * @path /users/{userId}/purchasedCourses/{courseId}
       * @allow (get, create, update, delete, list) Authenticated user accessing their own purchased courses.
       * @deny (get, create, update, delete, list) Any user attempting to access another user's purchased courses.
       * @principle Enforces document ownership for purchased courses.
       */
    match /users/{userId}/purchasedCourses/{courseId} {
        allow get, list, update, delete: if isOwner(userId) && resource != null;
        allow create: if isOwner(userId);
    }

    /**
     * @description Grants full access to employee data, but restricts access to admins.
     * @path /employees/{employeeId}
     * @allow (get, create, update, delete, list) Admin user with matching role.
     * @deny (get, create, update, delete, list) Non-admin user.
     * @principle Admin-only access for employee data.
     */
    match /employees/{employeeId} {
      allow get, list, create, update, delete: if isAdmin();
    }

    /**
     * @description Allows admins to create, read, update, and delete admin role documents. This effectively grants or revokes admin privileges.
     * @path /roles_admin/{userId}
     * @allow (get, create, update, delete, list) Admin user with matching role.
     * @deny (get, create, update, delete, list) Non-admin user.
     * @principle Admin-only access for setting admin roles.
     */
    match /roles_admin/{userId} {
        allow get, create, update, delete: if isAdmin();
        allow list: if isAdmin();
    }

    /**
     * @description Allows anyone to submit a contact form message, but restricts read, update, and delete to admins.
     * @path /contactMessages/{contactMessageId}
     * @allow (create) Public write access.
     * @allow (get, list, update, delete) Admin user with matching role.
     * @principle Public write for contact submissions, admin-only management.
     */
    match /contactMessages/{contactMessageId} {
      allow create: if true;
      allow get, list, update, delete: if isAdmin();
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  function isAdmin() {
    return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
  }
}
